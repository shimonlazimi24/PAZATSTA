# QA Checklist: Public PDF Link

## Overview

Lesson summary PDFs are sent via email with a **persistent public link** that:
- Works without login (no auth required)
- Never expires
- Is secure-by-unpredictability (long random token)
- Can be revoked by admin
- Can be regenerated by admin if leaked

## Pre-requisites

- `APP_URL` or `NEXT_PUBLIC_APP_URL` set in production
- Database migration `20260305000000_add_public_pdf_link` applied
- Lesson completed with summary (teacher fills report)

## QA Checklist

### 1. Logged out click from email → PDF opens

- [ ] Complete a lesson as teacher (fill report, submit)
- [ ] Check student/teacher/admin email for "דוח סיום שיעור"
- [ ] Log out (or use incognito)
- [ ] Click the CTA link in the email
- [ ] **Expected**: PDF opens in browser (inline view), no redirect to /login

### 2. Works on mobile Gmail

- [ ] Open the lesson-completed email on mobile (Gmail app or mobile web)
- [ ] Tap the "לצפייה ולהורדת דוח שיעור לחץ כאן" button
- [ ] **Expected**: PDF opens in browser or PDF viewer, no login prompt

### 3. Revoked link shows error page

- [ ] As admin, go to ניהול → קישורי דוחות PDF
- [ ] Enter a lesson ID that has a public link
- [ ] Click "בטל קישור" (Revoke) on an active link
- [ ] Open the old link URL (from email or copy)
- [ ] **Expected**: RTL Hebrew error page: "הקישור בוטל או אינו תקף"

### 4. Admin can regenerate new link

- [ ] As admin, go to קישורי דוחות PDF
- [ ] Enter lesson ID, click חפש
- [ ] Click "צור קישור חדש (מבטל ישנים)"
- [ ] **Expected**: New public URL displayed in green box
- [ ] Open the new URL (logged out)
- [ ] **Expected**: PDF opens
- [ ] Open the old URL
- [ ] **Expected**: Error page (revoked)

### 5. No login redirect occurs

- [ ] Ensure middleware excludes `/p/lesson-summary/`
- [ ] Visit `https://<APP_URL>/p/lesson-summary/<valid-token>` without session
- [ ] **Expected**: PDF or error page, never redirect to /login

### 6. Invalid token shows friendly error

- [ ] Visit `https://<APP_URL>/p/lesson-summary/invalid-token-123`
- [ ] **Expected**: RTL Hebrew error page, 404 status

### 7. Legacy /api/pdf links still work for logged-in users

- [ ] Log in as student
- [ ] Go to dashboard, click "צפייה ב-PDF" on a completed lesson
- [ ] **Expected**: PDF opens (uses /api/pdf/... which requires auth)

## Implementation Notes

- Token: 48 bytes random, base64url encoded
- Storage: Only SHA-256 hash of token in DB
- Route: `GET /p/lesson-summary/[token]` — no auth
- Middleware: `/p/lesson-summary/` in PUBLIC_PREFIXES
