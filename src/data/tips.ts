/**
 * Tips for lesson summary report, grouped by screening type.
 * Each tip has an id (for storage/dedup) and text.
 * Tips are shown as checkboxes based on the student's screening type.
 */

const TIP_SEP = "\n\n---\n\n";
const ID_SEP = ",";

export type TipItem = { id: string; label: string; text: string };
export type TipGroup = { label: string; tips: TipItem[] };

/** All tip groups. Label is section header, tips are checkbox options. */
export const TIP_GROUPS: TipGroup[] = [
  {
    label: "צו ראשון - מבחן דפ״ר",
    tips: [
      {
        id: "dafr-kvant-klali",
        label: "חשיבה כמותית - כללי",
        text: `חשיבה כמותית - כללי:
דרך לפתרון של שאלות נעשה על ידי השלבים הבאים:
• קוראים את השאלה
• מבינים מה סוג השאלה
• בודקים מה שואלים - מה צריך למצוא
• מבינים מהם הנתונים הברורים ומהם הנתונים נסתרים (שמסיקים מתוך הנתונים הברורים)
• משתמשים בשיטות פתרון
• שימוש בשיטת האלימינציה ככלל מנחה`,
      },
      {
        id: "dafr-kvant-hastabrut",
        label: "חשיבה כמותית - הסתברות",
        text: `חשיבה כמותית - הסתברות:
• יש לנו רצוי ומצוי כאשר רצוי זה מה שאנחנו רוצים למצוא ומבקשים בשאלה ומצוי זה כל מה שנתון לנו. רצוי חלקי מצוי זה הפתרון ודרך העבודה
• בסידורים אנחנו פשוט רואים מה מספר האפשרויות ואנחנו עושים כפל לאחור. לדוגמה אם יש לנו סידור של 4 עפרונות (כמו בשאלה שראינו) עושים 4 * 3 * 2 * 1 = התוצאה`,
      },
      {
        id: "dafr-kvant-geometria",
        label: "חשיבה כמותית - גאומטריה",
        text: `חשיבה כמותית - גאומטריה:
שלשות פיתגוריות שצריך לזכור:
• 3-4-5
• 6-8-10
• 5-12-13
• יש לנו הרבה צורות כמו משולש, משולש ישר זווית, ריבוע, מלבן, קוביה ותיבה
• חישוב נפח קוביה זה הצלע בשלישית
• חישוב בסיס הקוביה זה פשוט לחשב שטח של ריבוע
• חישוב נפח תיבה זה אורך כפול רוחב כפול גובה
• חישוב בסיס התיבה זה פשוט לחשב שטח מלבן`,
      },
      {
        id: "dafr-analogiot-miluliot",
        label: "אנלוגיות מילוליות",
        text: `אנלוגיות מילוליות:
• להתחיל בהגדרה של כל מילה בנפרד ואז למצוא את הקשר ביניהם
• אם אנחנו לא מכירים את אחת המילים בשאלה עוברים לבדיקת תשובות
• אם אנחנו לא מכירים את אחת המילים בתשובות עובדים מסודר עם מה שכן מכירים
• לא להטות מילים לצורות הגייה שונות
• לבדוק אם המילים הן שמות עצם, פועל, תואר או ציווי
• לשים לב מאיזה כיוון אנחנו בודקים את הקשר ולוודא שהקשר מתקיים גם בתשובות מאותו כיוון
• סוגי תבניות באנלוגיות: מילים נרדפות, מילים מנוגדות/הפוכות, ציווי ושם פעולה, משהו מתוך משהו (סיבה ותוצאה), העצמה/הפחתה
• לזכור שיש סוגי קשרים רגילים ואנחנו רוצים להגדיר לעצמנו את סוג הקשר של כל שאלה ואז לבדוק את התשובות בהתאם
• המבחן צובר ניקוד! כלומר גם אם את לא יודעת ומנחשת לא ירד לך ניקוד אלא את יכולה רק לזכות בעוד ניקוד, חשוב לנחש וחשוב עוד יותר לעשות את זה בזמן הנתון
• אם יש לך שאלה שאת לא מכירה את המילים בשאלה ולא בתשובה אז לא לבזבז את הזמן ולנסות להבין, לנחש ולהמשיך הלאה!
• ללמוד עוד מילים יעזור לך במבחן
• חלוקה לזמנים: 10 שניות ראשונות בדיקה ראשונית, 10 שניות הבאות בהתאם לידע, 10 שניות אחרונות של פסילת תשובות וקביעת התשובה הנכונה`,
      },
      {
        id: "dafr-havana-horaot",
        label: "הבנת הוראות",
        text: `הבנת הוראות:
• אתה צריך לכתוב לפני המבחן את השורות של האותיות, הערך הגימטרי ואת מיקומן בסדר האלפבית כדי להתחיל את המבחן בצורה מדויקת ומוכנה
• בשאלות של תנאי לא צריך לקרוא את כל השאלה, רק לקרוא את מה שרלוונטי בהתאם לתנאים`,
      },
      {
        id: "dafr-analogiot-tzuraniot",
        label: "אנלוגיות צורניות",
        text: `אנלוגיות צורניות - סוגי התבניות:
• סיבוב צורה - עם או נגד כיוון השעון, ובכמה מעלות, והאם זה כל הצורה או רק חלקה
• שינוי צבע - לאיזה כיוון הצבעים ״זזים״
• הגדלה/הפחתה - לרוב מגיע בצורות הנדסיות כמו משולשים/ריבועים/מחומשים וכו׳
• חיתוך צורה - צורה שנמצאת בתוך צורה גדולה יותר שמכילה מספר אלמנטים
• מראה אנכית - שינוי של הצורה מצד אחד לצד שני. למעלה למטה ולהפך
• מראה אופקית - שינוי של הצורה מצד אחד לצד שני. משמאל לימין ולהפך`,
      },
    ],
  },
  {
    label: "יום המא״ה - דינמיקה קבוצתית",
    tips: [
      {
        id: "maha-dinamika",
        label: "דינמיקה קבוצתית",
        text: `יום המא״ה - דינמיקה קבוצתית:
• לא להיות ״יס מן״ - להביע דעה ולהציג את מה שחשוב לך כל הזמן
• לא להיות ״מנהיג שלילי״ - להכיל את האחרים לשמוע דעות ולא לקטוע/לבטל או להחליט לאחרים מה הם חושבים ורוצים
• להיות עם סטופר/טיימר לניהול הזמן הקבוצתי ולהיות שעון דובר
• לכתוב את כל ההצעות של כולם כדי לשלוט הרעיונות ובניהול הקבוצה
• לזכור את אפקט הראשון, אפקט האחרון ואפקט העדר
• לנסות להוביל ולא להתבייש להגיד את דעתנו תוך כדי הדיון, לשתף חברים נוספים וכאלו שפחות מורגשים כדי להוסיף לעצמך נקודות על יכולת שליטה, פיקוד, עבודת צוות וניהול
• לנהל את הדיון ממקום לא של אגו אלא של הגעה לפתרון והצלחת המשימה
• תמדוד זמנים לאורך כל התחנה
• תציין דברים שאתה עושה ואל תתבייש להגיד אותם בקול
• תזכור את אפקט הראשונים, האחרונים והעדר
• תכתוב מה אנשים אחרים אומרים בהתאם למשימה זה יעזור לך להיות מסודר ולשפר את יכולת השכנוע שלך`,
      },
    ],
  },
  {
    label: "יום המא״ה - תחנת הדרכה",
    tips: [
      {
        id: "maha-hadracha",
        label: "תחנת הדרכה",
        text: `יום המא״ה תחנת הדרכה:
• להתחיל בשאלה מעניינת ולהשתמש בהרמות יד כדי לייצר עניין!
• לבנות את המצגת לפי השלבים:
  - פתיחה - לפתוח בהצגה עצמית קצרה ושאלה מעניינת שתתחיל את הנושא (עד 30 שניות)
  - תוכן - לדבר על הדברים שחשובים לך ומעניינים אותך ושיש להם קשר גם אל ההפעלה כדי לייצר את הקישוריות והמעבר החלק בין הנושאים של ההדרכה
  - הפעלה - החלק החשוב ביותר בהדרכה שצריך להיות אקטיבים ולגרום לקהל להשתתף ולהעביר להם את המשחק הנתון בתוך המצגת בצורה קלילה וכיפית
  - סיכום - משפט קצר שמסכם הכל וזמן לשאלות (לא יותר מ-20-25 שניות)
• לקשר את ההפעלה לתוכן כדי שיהיה לך מה לשאול בצורה טובה וברורה
• לא להראות שנתקעת גם אם זה קרה, לחייך ולהמשיך לנקודה הבאה`,
      },
    ],
  },
  {
    label: "יום המא״ה - תחנת סימולציה אישית",
    tips: [
      {
        id: "maha-simulazia",
        label: "תחנת סימולציה אישית",
        text: `יום המא״ה תחנת סימולציה אישית:
המבנה של הפתרון לסימולציה קשה:
1. לשאול שאלות מקדימות
2. לשנות נקודת כיוון והתבוננות
3. להמציא המצאות נוספות
4. להגיש פתרון יצירתי
• לא להשתמש במילים כמו ״אי אפשר״, ״אסור״, לא מוחלט. עדיף להשתמש במילות קישור כמו: מאתגר/מורכב/מסובך/קשה/בעייתי
• לא לשכוח שזה דיאלוג שאתם מדברים ומקשיבים. המטרה לתת אוזן קשבת ולמצוא דרך לתת תחושת עזרה והדדיות
• חלוקה של השלבים: לשאול הרבה שאלות, להמציא המצאות, לתת פתרון יצירתי
• לא לשכוח שמדובר כאן על מסירה של הודעה והמטרה היא להיות אכפתיים/אמפתיים/מכילים ורגישים. זה יותר מונולוג שלך ופחות שיחה פתוחה`,
      },
    ],
  },
  {
    label: "יום המא״ה - מבחנים פסיכוטכניים",
    tips: [
      {
        id: "maha-psicho",
        label: "מבחנים פסיכוטכניים",
        text: `יום המא״ה - מבחנים פסיכוטכניים:
• תרשימי זרימה - לזכור את סוגי השאלות ולראות לאן החצים מתקדמים כדי לדעת מה התוצאה או מה הסיבה
• עיבוד מילולי - לא צריך לקרוא את כל הפסקאות בהתחלה, חשוב כן להבין מה הפרמטרים בכל נושא כדי לדעת איך להתייחס ורק לפי השאלות להשתמש בשיטת האלימינציה
• הבנה טכנית - בעזרת קריאת הטבלאות ומציאת השאלות הנכונות אפשר לפתור את רוב השאלות במהירות וללא בעיה + אין צורך לקרוא את ההסבר המקדים כדי לא להתבלבל או לבזבז אנרגיה`,
      },
    ],
  },
  {
    label: "כלל חמ״ן - מבחן פסיכוטכני",
    tips: [
      {
        id: "haman-psicho",
        label: "כלל חמ״ן - מבחן פסיכוטכני",
        text: `כלל חמ״ן - מבחן פסיכוטכני:
• בשאלות של כללים ושיבוצים (לוגיקה) נשים לב מה שואלים אותנו - אם כתוב ״בהכרח״ ״בלבד״ או ״רק״ נדע שזה מוחלט, לעומת מילים כמו ״יכול״ ״ייתכן״ או ״אפשרי״. הסמנטיקה פה מאוד משמעותית
• סדרות ספרתיות - צריך לזכור: 4-5 ספרות = חוקיות אחת. 5-6 ספרות = 2 תתי סדרות עם חוקיות שונה. יכול להיות חיבור, חיסור, כפל, חילוק, שורש, חזקה או עצרת. להגיע עם ראש פתוח ולנחש בצורה מושכלת אם לא יודע
• בשאלות הסקת מסקנות - לקרוא את השאלות עד הסוף ואז לשרטט ולהבין בדיוק מה אפשרי ומה פחות בהתאם
• אנלוגיות מילוליות: להתחיל בהגדרה של כל מילה בנפרד, לבדוק אם מכירים את המילים, לא להטות מילים, לבדוק סוג מילה (שם עצם/פועל/תואר/ציווי), לשים לב לכיוון הבדיקה`,
      },
    ],
  },
  {
    label: "ירפ״א א׳ - מבחן פסיכוטכני",
    tips: [
      {
        id: "yirpa-psicho",
        label: "ירפ״א א׳ - מבחן פסיכוטכני",
        text: `ירפ״א א׳ - מבחן פסיכוטכני:
1. במבחן הקוביה תזכור את החוקים הבאים:
   א. יש 6 פאות
   ב. יש מרכז 1 לכל פאה (מ׳)
   ג. יש 4 פאות (פ׳) ו-4 צדדים (צ׳)
   ד. כל פאה מקיימת קו דימוני ישר שהולך לפאה הנגדית אליה!

2. החוקים הברורים של הקוביה:
   א. אם יש לנו מ׳ ומ׳ הם תמיד יפגשו באמצע
   ב. אם יש לנו את אותם האותיות ב-2 נקודות, הן לעולם לא יפגשו
   ג. אם יש לנו את אותם הפאות (פ) ב-2 נקודות, הן יפגשו או בהתחלה (אם הן צמודות) או בסוף, או לא יפגשו בכלל
   ד. פאה ופאה או צד וצד יכולים להיפגש רק ובלבד אם הן באותיות נגדיות ונמצאות בהכרח באותו המיקום ביחס לפאה הנגדית

3. בראייה מרחבית של המטוסים:
   • להסתכל על הכיוון של הפנייה של המטוס - אם הצד השמאלי גבוה יותר המטוס פונה שמאלה והפוך
   • לבחון את הקרקע ולהחליט בהתאם לסוג השאלה - אם מהקרקע לכיוון המטוס לא לשכוח שיש השתקפות מראה והקרקע נראת הפוך
   • אם צריך לקבוע איך נראה המטוס מהקרקע - לזכור שהפנייה היא אותה הזווית במטוס מבפנים בתא הטייס וגם בהסתכלות עליו מהצד השני`,
      },
    ],
  },
  {
    label: "כלליים",
    tips: [
      {
        id: "klalim",
        label: "הפסקות וניהול זמן",
        text: `כלליים:
• לקחת הפסקות בין הפרקים ולנצל את כל היום במלואו למלא את המבחן בנחת וברוגע`,
      },
    ],
  },
];

/** Map screening type (partial match) to tip group labels. First match wins. */
const SCREENING_TO_TIP_LABELS: { pattern: RegExp | string; labels: string[] }[] = [
  { pattern: /דפ[״']?ר משטרה/, labels: ["צו ראשון - מבחן דפ״ר", "כלליים"] },
  { pattern: /צו ראשון.*דפ[״']?ר|דפ[״']?ר.*צו ראשון/, labels: ["צו ראשון - מבחן דפ״ר", "כלליים"] },
  {
    pattern: /תחנות קבוצתיות|דינמיקה קבוצתית/,
    labels: ["יום המא״ה - דינמיקה קבוצתית", "יום המא״ה - תחנת הדרכה", "יום המא״ה - תחנת סימולציה אישית", "כלליים"],
  },
  {
    pattern: /יום המא[״']?ה.*פסיכוטכני/,
    labels: ["יום המא״ה - מבחנים פסיכוטכניים", "כלליים"],
  },
  {
    pattern: /כלל חמ[״']?ן.*פסיכוטכני|שחקים.*פסיכוטכני/,
    labels: ["כלל חמ״ן - מבחן פסיכוטכני", "כלליים"],
  },
  {
    pattern: /ירפ[״']?א א[״']?|קורס טיס.*א[״']?/,
    labels: ["ירפ״א א׳ - מבחן פסיכוטכני", "כלליים"],
  },
  {
    pattern: /סייבר|מיון ראשוני/,
    labels: ["כלל חמ״ן - מבחן פסיכוטכני", "כלליים"],
  },
  { pattern: /.*/, labels: ["כלליים"] }, // fallback: show at least general
];

/** Get tip groups to display for a given screening type. */
export function getTipsForScreening(screeningType: string): TipGroup[] {
  const trimmed = screeningType.trim();
  if (!trimmed) {
    return TIP_GROUPS.filter((g) => g.label === "כלליים");
  }
  for (const { pattern, labels } of SCREENING_TO_TIP_LABELS) {
    const matches =
      typeof pattern === "string"
        ? trimmed.includes(pattern)
        : pattern.test(trimmed);
    if (matches) {
      return TIP_GROUPS.filter((g) => labels.includes(g.label));
    }
  }
  return TIP_GROUPS.filter((g) => g.label === "כלליים");
}

/** All tips by id for lookup. */
const TIPS_BY_ID = new Map<string, TipItem>();
for (const g of TIP_GROUPS) {
  for (const t of g.tips) TIPS_BY_ID.set(t.id, t);
}

/** Parse stored tips: supports legacy (comma-separated text) or new format (id1,id2,id3). */
export function parseTipsToIds(tips: string): Set<string> {
  const ids = new Set<string>();
  const s = tips.trim();
  if (!s) return ids;
  const parts = s.split(ID_SEP).map((p) => p.trim()).filter(Boolean);
  for (const p of parts) {
    if (TIPS_BY_ID.has(p)) {
      ids.add(p);
    }
  }
  return ids;
}

/** Build tips string for storage (id1,id2,id3) and for display/PDF (full text). */
export function buildTipsFromIds(selectedIds: Set<string>): string {
  const ids: string[] = [];
  for (const group of TIP_GROUPS) {
    for (const tip of group.tips) {
      if (selectedIds.has(tip.id)) ids.push(tip.id);
    }
  }
  return ids.join(ID_SEP);
}

/** Get full tips text for PDF/display from stored tips string. Handles legacy (plain text) format. */
export function getTipsDisplayText(tips: string): string {
  const ids = parseTipsToIds(tips);
  if (ids.size > 0) {
    const texts: string[] = [];
    for (const group of TIP_GROUPS) {
      for (const tip of group.tips) {
        if (ids.has(tip.id)) texts.push(tip.text);
      }
    }
    return texts.join(TIP_SEP);
  }
  return tips.trim() || "";
}
